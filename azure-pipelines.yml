# azure-pipelines.yml
trigger:
- main

variables:
  # Hardcoded values (replace with yours)
  AZURE_TENANT_ID: '1179f18f-155e-4233-a144-27bc24f64401'  # Must be quoted
  APP_NAME: 'my-flask-app'
  RESOURCE_GROUP: 'my-resource-group'
  PYTHON_VERSION: '3.11'
  VM_IMAGE: 'ubuntu-latest'

  # Reference variable group for secrets
  -group: azure-creds  # Contains:
    # AZURE_CLIENT_ID
    # AZURE_CLIENT_SECRET
    # AZURE_SUBSCRIPTION_ID

stages:
- stage: Validate
  displayName: Validate Variables
  jobs:
  - job: Validate
    pool:
      vmImage: $(VM_IMAGE)
    steps:
    - bash: |
        echo "##[group]Variable Validation"
        echo "TENANT_ID: $(AZURE_TENANT_ID)"
        echo "CLIENT_ID: $(AZURE_CLIENT_ID)"
        echo "SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)"
        echo "##[endgroup]"
        
        if [ -z "$(AZURE_CLIENT_ID)" ]; then
          echo "##vso[task.logissue type=error]CLIENT_ID is empty!"
          exit 1
        fi
      displayName: 'Verify Variables'

- stage: Deploy
  displayName: Deploy to Azure
  dependsOn: Validate
  condition: succeeded()
  jobs:
  - job: Deploy
    pool:
      vmImage: $(VM_IMAGE)
    steps:
    - bash: |
        set -e
        echo "##[group]Final Variables"
        echo "TENANT_ID: $(AZURE_TENANT_ID)"
        echo "CLIENT_ID: $(AZURE_CLIENT_ID)"
        echo "SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)"
        echo "##[endgroup]"
        
        echo "##[section]Authenticating..."
        az login --service-principal \
          -u "$(AZURE_CLIENT_ID)" \
          -p "$(AZURE_CLIENT_SECRET)" \
          --tenant "$(AZURE_TENANT_ID)"
        
        echo "##[section]Deploying..."
        az webapp deployment source config-zip \
          --resource-group "$(RESOURCE_GROUP)" \
          --name "$(APP_NAME)" \
          --src "$(Pipeline.Workspace)/drop/app.zip"
        
        echo "##[section]Deployed to https://$(APP_NAME).azurewebsites.net"
      displayName: 'Azure Deployment'
      env:
        AZURE_CLIENT_SECRET: $(AZURE_CLIENT_SECRET)  # Secret from variable group